#!/usr/bin/env ruby
# frozen_string_literal: true

#
# scripts/goal-list - List pipeline goals
#
# Usage: goal-list [--status STATUS] [--org ORG] [--repo REPO]
#
# Output: JSON {"ok": true, "items": [...]}
# Exit code: 0 on success, 1 on failure
#

require 'json'
require 'net/http'
require 'optparse'

RALPH_PLANS_HOST = ENV.fetch('RALPH_PLANS_HOST')
RALPH_PLANS_PORT = ENV.fetch('RALPH_PLANS_PORT')

VALID_STATUSES = %w[draft queued running done stuck cancelled].freeze

def main
  status = nil
  org = nil
  repo = nil

  OptionParser.new do |opts|
    opts.banner = <<~HELP
      Usage: goal-list [--status STATUS] [--org ORG] [--repo REPO]

      List pipeline goals.

      Flags:
        --status STATUS   Filter by status (#{VALID_STATUSES.join(', ')})
        --org ORG         Filter by organization
        --repo REPO       Filter by repository name

      Output:
        JSON {"ok": true, "items": [...]}
        Each item: {id, org, repo, title, status}

      Examples:
        goal-list                          # all goals
        goal-list --status queued          # only queued goals
        goal-list --org mgreenly           # goals for an org
        goal-list --org mgreenly --repo ikigai
    HELP

    opts.on('--status=STATUS', 'Filter by status') { |s| status = s }
    opts.on('--org=ORG', 'Filter by organization') { |o| org = o }
    opts.on('--repo=REPO', 'Filter by repository') { |r| repo = r }
  end.parse!

  # Support positional status arg for backwards compat
  status ||= ARGV[0]

  if status && !VALID_STATUSES.include?(status)
    puts JSON.generate(ok: false, error: "invalid status: #{status} (valid: #{VALID_STATUSES.join(', ')})")
    exit 1
  end

  uri = URI("http://#{RALPH_PLANS_HOST}:#{RALPH_PLANS_PORT}/goals")
  params = {}
  params['status'] = status if status
  params['org'] = org if org
  params['repo'] = repo if repo
  uri.query = URI.encode_www_form(params) unless params.empty?

  resp = Net::HTTP.get_response(uri)
  result = JSON.parse(resp.body)

  puts JSON.generate(result)
  exit(result['ok'] ? 0 : 1)
rescue Errno::ECONNREFUSED
  puts JSON.generate(ok: false, error: "cannot connect to ralph-plans at #{RALPH_PLANS_HOST}:#{RALPH_PLANS_PORT}")
  exit 1
end

if __FILE__ == $PROGRAM_NAME
  begin
    main
  rescue Interrupt
    exit 130
  end
end
