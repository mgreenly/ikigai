#!/usr/bin/env ruby
# frozen_string_literal: true

#
# scripts/goal-create - Create a pipeline goal via ralph-plans API
#
# Reads goal body from stdin. Metadata via flags.
#
# Usage: goal-create --title "..." --org ORG --repo REPO < body.md
#
# Output: JSON {"ok": true, "id": <goal-id>}
# Exit code: 0 on success, 1 on failure
#

require 'json'
require 'net/http'
require 'optparse'

RALPH_PLANS_HOST = ENV.fetch('RALPH_PLANS_HOST')
RALPH_PLANS_PORT = ENV.fetch('RALPH_PLANS_PORT')

def main
  title = nil
  org = nil
  repo = nil

  OptionParser.new do |opts|
    opts.banner = <<~HELP
      Usage: goal-create --title "..." --org ORG --repo REPO < body.md

      Create a pipeline goal. Body is read from stdin.

      Flags:
        --title "..."       Goal title (required)
        --org ORG           Organization (required)
        --repo REPO         Repository name (required)

      Output:
        JSON {"ok": true, "id": <goal-id>}

      Examples:
        echo "## Objective\\nDo the thing" | goal-create --title "Add X" --org mgreenly --repo ikigai
    HELP

    opts.on('--title=TITLE', 'Goal title') { |t| title = t }
    opts.on('--org=ORG', 'Organization') { |o| org = o }
    opts.on('--repo=REPO', 'Repository name') { |r| repo = r }
  end.parse!

  unless title
    puts JSON.generate(ok: false, error: '--title is required')
    exit 1
  end

  unless org
    puts JSON.generate(ok: false, error: '--org is required')
    exit 1
  end

  unless repo
    puts JSON.generate(ok: false, error: '--repo is required')
    exit 1
  end

  # Read body from stdin
  if $stdin.tty?
    puts JSON.generate(ok: false, error: 'body must be provided on stdin')
    exit 1
  end

  body = $stdin.read.strip

  if body.empty?
    puts JSON.generate(ok: false, error: 'body is empty')
    exit 1
  end

  # POST to ralph-plans API
  uri = URI("http://#{RALPH_PLANS_HOST}:#{RALPH_PLANS_PORT}/goals")
  payload = { org: org, repo: repo, title: title, body: body }

  resp = Net::HTTP.post(uri, JSON.generate(payload), 'Content-Type' => 'application/json')
  result = JSON.parse(resp.body)

  puts JSON.generate(result)
  exit(result['ok'] ? 0 : 1)
rescue Errno::ECONNREFUSED
  puts JSON.generate(ok: false, error: "cannot connect to ralph-plans at #{RALPH_PLANS_HOST}:#{RALPH_PLANS_PORT}")
  exit 1
end

if __FILE__ == $PROGRAM_NAME
  begin
    main
  rescue Interrupt
    exit 130
  end
end
