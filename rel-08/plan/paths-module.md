# Path Resolution Module

Infrastructure for accessing installation directories. All path logic handled by wrapper script at install time.

## Purpose

Single source of truth for all ikigai installation paths. Reads directory paths from environment variables set by the wrapper script.

## Module Location

- `src/paths.c` - Implementation
- `src/paths.h` - Public interface

## Wrapper Script Approach

**Problem:** Different PREFIX values require different directory structures:
- `/usr` uses `/etc/ikigai/` (not `/usr/etc/ikigai/`)
- `/usr/local` uses `/usr/local/etc/ikigai/`
- `/opt/ikigai` uses `/opt/ikigai/etc/` (not `/opt/ikigai/etc/ikigai/`)
- `$HOME/.local` uses `~/.config/ikigai/` (XDG standard)

**Solution:** Makefile generates a wrapper script that computes all paths at install time and exports them as environment variables.

### Install Structure

```
$PREFIX/bin/ikigai              # wrapper script (generated by make install)
$PREFIX/libexec/ikigai/ikigai   # actual binary
$PREFIX/libexec/ikigai/bash     # tool executables
$PREFIX/libexec/ikigai/file-read
...
```

### Wrapper Script Examples

**PREFIX=/usr/local:**
```bash
#!/bin/sh
IKIGAI_BIN_DIR=/usr/local/bin
IKIGAI_CONFIG_DIR=/usr/local/etc/ikigai
IKIGAI_DATA_DIR=/usr/local/share/ikigai
IKIGAI_LIBEXEC_DIR=/usr/local/libexec/ikigai
export IKIGAI_BIN_DIR IKIGAI_CONFIG_DIR IKIGAI_DATA_DIR IKIGAI_LIBEXEC_DIR
exec /usr/local/libexec/ikigai/ikigai "$@"
```

**PREFIX=/usr:**
```bash
#!/bin/sh
IKIGAI_BIN_DIR=/usr/bin
IKIGAI_CONFIG_DIR=/etc/ikigai
IKIGAI_DATA_DIR=/usr/share/ikigai
IKIGAI_LIBEXEC_DIR=/usr/libexec/ikigai
export IKIGAI_BIN_DIR IKIGAI_CONFIG_DIR IKIGAI_DATA_DIR IKIGAI_LIBEXEC_DIR
exec /usr/libexec/ikigai/ikigai "$@"
```

**PREFIX=/opt/ikigai:**
```bash
#!/bin/sh
IKIGAI_BIN_DIR=/opt/ikigai/bin
IKIGAI_CONFIG_DIR=/opt/ikigai/etc
IKIGAI_DATA_DIR=/opt/ikigai/share
IKIGAI_LIBEXEC_DIR=/opt/ikigai/libexec
export IKIGAI_BIN_DIR IKIGAI_CONFIG_DIR IKIGAI_DATA_DIR IKIGAI_LIBEXEC_DIR
exec /opt/ikigai/libexec/ikigai/ikigai "$@"
```

**PREFIX=$HOME/.local:**
```bash
#!/bin/sh
IKIGAI_BIN_DIR=$HOME/.local/bin
IKIGAI_CONFIG_DIR=$HOME/.config/ikigai
IKIGAI_DATA_DIR=$HOME/.local/share/ikigai
IKIGAI_LIBEXEC_DIR=$HOME/.local/libexec/ikigai
export IKIGAI_BIN_DIR IKIGAI_CONFIG_DIR IKIGAI_DATA_DIR IKIGAI_LIBEXEC_DIR
exec $HOME/.local/libexec/ikigai/ikigai "$@"
```

## Supported Install Prefixes

| PREFIX | Bin | Config | Data | Libexec |
|--------|-----|--------|------|---------|
| `/usr` | `/usr/bin/` | `/etc/ikigai/` | `/usr/share/ikigai/` | `/usr/libexec/ikigai/` |
| `/usr/local` | `/usr/local/bin/` | `/usr/local/etc/ikigai/` | `/usr/local/share/ikigai/` | `/usr/local/libexec/ikigai/` |
| `/opt/ikigai` | `/opt/ikigai/bin/` | `/opt/ikigai/etc/` | `/opt/ikigai/share/` | `/opt/ikigai/libexec/` |
| `$HOME/.local` | `$HOME/.local/bin/` | `$HOME/.config/ikigai/` | `$HOME/.local/share/ikigai/` | `$HOME/.local/libexec/ikigai/` |

**Note:** Only `/usr/local` is supported by `make install`. Other prefixes work if installed manually with correct wrapper script.

## Public Interface

### Types

```c
// src/paths.h
typedef struct ik_paths_t ik_paths_t;  // Opaque type - struct defined privately
```

### Functions

```c
// Initialize path resolution (call once at startup)
// Reads paths from environment variables set by wrapper script
res_t ik_paths_init(TALLOC_CTX *ctx, ik_paths_t **out);

// Get specific directory paths
const char *ik_paths_get_bin_dir(ik_paths_t *paths);
const char *ik_paths_get_config_dir(ik_paths_t *paths);
const char *ik_paths_get_data_dir(ik_paths_t *paths);
const char *ik_paths_get_tools_system_dir(ik_paths_t *paths);
const char *ik_paths_get_tools_user_dir(ik_paths_t *paths);
const char *ik_paths_get_tools_project_dir(ik_paths_t *paths);
```

### Path Meanings

| Path | Purpose | Always Same? |
|------|---------|--------------|
| bin_dir | Binary directory | No - from `IKIGAI_BIN_DIR` |
| config_dir | Configuration files | No - from `IKIGAI_CONFIG_DIR` |
| data_dir | Documentation, examples | No - from `IKIGAI_DATA_DIR` |
| tools_system_dir | Shipped tools (6 built-ins) | No - from `IKIGAI_LIBEXEC_DIR` |
| tools_user_dir | User's personal tools | Yes - always `~/.ikigai/tools/` |
| tools_project_dir | Project-specific tools | Yes - always `.ikigai/tools/` |

## Implementation Details

### Struct Definition (Private to src/paths.c)

```c
// src/paths.c - defined privately in implementation file only
struct ik_paths_t {
    char *bin_dir;              // From IKIGAI_BIN_DIR
    char *config_dir;           // From IKIGAI_CONFIG_DIR
    char *data_dir;             // From IKIGAI_DATA_DIR
    char *tools_system_dir;     // From IKIGAI_LIBEXEC_DIR
    char *tools_user_dir;       // Always ~/.ikigai/tools/
    char *tools_project_dir;    // Always .ikigai/tools/
};
```

**Note:** This struct is NOT in a header file. It's defined privately in `src/paths.c`. Production code only sees the opaque typedef from `src/paths.h`.

### Implementation

```c
// src/paths.c
res_t ik_paths_init(TALLOC_CTX *ctx, ik_paths_t **out) {
    ik_paths_t *paths = talloc_zero(ctx, ik_paths_t);

    // Read from environment (set by wrapper script)
    const char *bin = getenv("IKIGAI_BIN_DIR");
    const char *config = getenv("IKIGAI_CONFIG_DIR");
    const char *data = getenv("IKIGAI_DATA_DIR");
    const char *libexec = getenv("IKIGAI_LIBEXEC_DIR");

    if (!bin || !config || !data || !libexec) {
        return ERR(ERR_INVALID_STATE, "Missing IKIGAI_*_DIR environment variables");
    }

    // Copy to paths struct
    paths->bin_dir = talloc_strdup(paths, bin);
    paths->config_dir = talloc_strdup(paths, config);
    paths->data_dir = talloc_strdup(paths, data);
    paths->tools_system_dir = talloc_strdup(paths, libexec);

    // These are always the same regardless of install
    paths->tools_user_dir = expand_tilde(paths, "~/.ikigai/tools");
    paths->tools_project_dir = talloc_strdup(paths, ".ikigai/tools");

    *out = paths;
    return OK();
}
```

### Helper Functions (Internal)

```c
// Expand ~ to HOME directory
// ~/foo → /home/user/foo
static char *expand_tilde(TALLOC_CTX *ctx, const char *path);
```

**Note:** Move `ik_cfg_expand_tilde()` from config module to paths module. Make it internal (static).

## Integration Points

### 1. REPL Context

Paths instance stored in root context:

```c
struct ik_repl_ctx_t {
    ik_paths_t *paths;          // Injected at init (created in main)
    ik_cfg_t *cfg;              // Config loader uses paths
    ik_db_ctx_t *db;            // Database
    ik_llm_client_t *llm;       // LLM client
    // ... other fields
};
```

### 2. Main Initialization

```c
int main(void) {
    TALLOC_CTX *root_ctx = talloc_new(NULL);

    // Create paths instance first (other subsystems may need it)
    ik_paths_t *paths = NULL;
    TRY(ik_paths_init(root_ctx, &paths));

    // Pass to REPL initialization
    ik_repl_ctx_t *repl = NULL;
    TRY(ik_repl_init(root_ctx, paths, &repl));

    ik_repl_run(repl);

    talloc_free(root_ctx);
    return 0;
}
```

### 3. Tool Discovery

Tool discovery receives directory paths:

```c
// In REPL initialization or wherever discovery is triggered
res_t result = ik_tool_discovery_run(
    ctx,
    ik_paths_get_tools_system_dir(repl->paths),   // System tools
    ik_paths_get_tools_user_dir(repl->paths),     // User tools
    ik_paths_get_tools_project_dir(repl->paths),  // Project tools
    repl->tool_registry
);
```

### 4. Config Loading

Config loader uses single path (no cascading):

```c
// Config loading - single path only
res_t ik_cfg_load(TALLOC_CTX *ctx, ik_paths_t *paths, ik_cfg_t **out_cfg) {
    // Use install-appropriate config dir
    char *config_path = talloc_asprintf(ctx, "%s/config",
                                        ik_paths_get_config_dir(paths));
    if (file_exists(config_path)) {
        return load_config_file(ctx, config_path, out_cfg);
    }

    // No config found - create default
    return create_default_config(ctx, out_cfg);
}
```

**Note:** No cascading config search. One config location per install.

## Memory Management

- Paths instance allocated on `root_ctx` (lives entire application lifetime)
- All path strings allocated as children of `ik_paths_t` instance
- Freed automatically when `root_ctx` is freed at shutdown
- No manual cleanup needed

## Error Handling

```c
res_t ik_paths_init(TALLOC_CTX *ctx, ik_paths_t **out) {
    // Failure cases:
    // - Missing IKIGAI_*_DIR env vars → ERR_INVALID_STATE
    // - Cannot expand ~ (no HOME env var) → ERR_IO
    // - Out of memory → PANIC (talloc failures)
}
```

## Development Mode

For development (running from source tree without installing):

### Option 1: .envrc (direnv) - Recommended

Create `.envrc` in project root:
```bash
# .envrc
export IKIGAI_BIN_DIR=$PWD/bin
export IKIGAI_CONFIG_DIR=$PWD/etc/ikigai
export IKIGAI_DATA_DIR=$PWD/share/ikigai
export IKIGAI_LIBEXEC_DIR=$PWD/libexec/ikigai
```

Then run:
```bash
direnv allow
./libexec/ikigai/ikigai  # Environment automatically set
```

### Option 2: Development wrapper script

Create `bin/ikigai` wrapper (checked into repo):
```bash
#!/bin/sh
IKIGAI_BIN_DIR="$PWD/bin"
IKIGAI_CONFIG_DIR="$PWD/etc/ikigai"
IKIGAI_DATA_DIR="$PWD/share/ikigai"
IKIGAI_LIBEXEC_DIR="$PWD/libexec/ikigai"
export IKIGAI_BIN_DIR IKIGAI_CONFIG_DIR IKIGAI_DATA_DIR IKIGAI_LIBEXEC_DIR
exec "$PWD/libexec/ikigai/ikigai" "$@"
```

### Option 3: Manual environment variables

```bash
export IKIGAI_BIN_DIR=$PWD/bin
export IKIGAI_CONFIG_DIR=$PWD/etc/ikigai
export IKIGAI_DATA_DIR=$PWD/share/ikigai
export IKIGAI_LIBEXEC_DIR=$PWD/libexec/ikigai
./libexec/ikigai/ikigai
```

## Testing Strategy

### Test Helper for Most Tests

Most tests just need standard paths and don't care about the details. Provide a simple helper:

```c
// tests/test_helpers.h
ik_paths_t *ik_paths_create_test(TALLOC_CTX *ctx);

// tests/test_helpers.c
#include "paths_test.h"  // Gets struct definition

ik_paths_t *ik_paths_create_test(TALLOC_CTX *ctx) {
    ik_paths_t *paths = talloc_zero(ctx, ik_paths_t);
    paths->bin_dir = talloc_strdup(paths, "tests/bin");
    paths->config_dir = talloc_strdup(paths, "tests/config");
    paths->data_dir = talloc_strdup(paths, "tests/data");
    paths->tools_system_dir = talloc_strdup(paths, "tests/tools/system");
    paths->tools_user_dir = talloc_strdup(paths, "tests/tools/user");
    paths->tools_project_dir = talloc_strdup(paths, "tests/tools/project");
    return paths;
}
```

**Usage in most tests:**
```c
// Just use the helper - don't think about paths
ik_paths_t *paths = ik_paths_create_test(test_ctx);
ik_repl_init(test_ctx, paths, &repl);
```

### Tests That Need Custom Paths

For tests that need specific path values, construct directly:

```c
// tests/paths_test.h - duplicates struct definition for test construction
#include "paths.h"

struct ik_paths_t {
    char *bin_dir;
    char *config_dir;
    char *data_dir;
    char *tools_system_dir;
    char *tools_user_dir;
    char *tools_project_dir;
};
```

**Usage in custom tests:**
```c
#include "paths_test.h"

// Build exactly what this test needs
ik_paths_t *paths = talloc_zero(test_ctx, ik_paths_t);
paths->config_dir = "/tmp/my-custom-config";
paths->tools_system_dir = "/custom/tools/location";
// ... set fields as needed

ik_repl_init(test_ctx, paths, &repl);
```

**Important:** The struct definition in `tests/paths_test.h` must be kept in sync with `src/paths.c`. Tests will fail quickly if they drift.

### Unit Tests for paths.c Module

Test environment variable reading:

```c
// Test successful initialization
void test_paths_init_success(void);

// Test missing environment variables
void test_paths_init_missing_env_vars(void);

// Test tilde expansion
void test_paths_tilde_expansion(void);

// Test accessor functions
void test_paths_getters(void);
```

### Test Approach for paths.c

Since this module depends on environment variables:

```c
// Set environment before test
setenv("IKIGAI_BIN_DIR", "/test/bin", 1);
setenv("IKIGAI_CONFIG_DIR", "/test/config", 1);
setenv("IKIGAI_DATA_DIR", "/test/data", 1);
setenv("IKIGAI_LIBEXEC_DIR", "/test/libexec", 1);

ik_paths_t *paths = NULL;
res_t result = ik_paths_init(test_ctx, &paths);

assert(result.ok);
assert_string_equal(ik_paths_get_bin_dir(paths), "/test/bin");
assert_string_equal(ik_paths_get_config_dir(paths), "/test/config");

// Clean up
unsetenv("IKIGAI_BIN_DIR");
unsetenv("IKIGAI_CONFIG_DIR");
unsetenv("IKIGAI_DATA_DIR");
unsetenv("IKIGAI_LIBEXEC_DIR");
```

## References

Complete specification: `project/install-directories.md`

## Migration Notes

This is **new infrastructure** that must be implemented before tool discovery (Phase 1).

**Task order:**
1. Implement paths module (src/paths.c, src/paths.h)
2. Create test infrastructure (tests/paths_test.h, update tests/test_helpers.c)
3. Update REPL initialization to create and store paths instance
4. Fix tests that break (add paths parameter where needed)
5. Update tool discovery to receive directory paths from paths module
6. Update config loading to use paths module
7. Update Makefile to generate wrapper script

**Test impact:** Many tests will break when `ik_repl_init()` signature changes to require `ik_paths_t *`. Fix by using `ik_paths_create_test()` helper. Most tests just need one line added.

**Before:**
```c
ik_repl_init(test_ctx, &repl);
```

**After:**
```c
ik_paths_t *paths = ik_paths_create_test(test_ctx);
ik_repl_init(test_ctx, paths, &repl);
```

## Code Cleanup Required

While this module is new infrastructure, it **replaces** existing hardcoded path logic:

**Production code cleanup:**
1. Remove hardcoded `"~/.config/ikigai/config.json"` from `src/client.c:50`
2. Remove `working_dir` and `ikigai_subdir` parameters from `ik_shared_ctx_init()` signature
3. Remove `path` parameter from `ik_config_load()` signature
4. Move `ik_cfg_expand_tilde()` from config module to paths module (internal)

**See:** `plan/paths-test-migration.md` for complete cleanup specification.
