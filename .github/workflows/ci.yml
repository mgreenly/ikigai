name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    container:
      image: debian:13.2@sha256:c71b05eac0b20adb4cdcc9f7b052227efd7da381ad10bb92f972e8eae7c6cdc9
      env:
        PGHOST: postgres
        IKIGAI_DEV: 1
        IKIGAI_BIN_DIR: ${{ github.workspace }}/bin
        IKIGAI_CONFIG_DIR: ${{ github.workspace }}/etc/ikigai
        IKIGAI_DATA_DIR: ${{ github.workspace }}/share/ikigai
        IKIGAI_LIBEXEC_DIR: ${{ github.workspace }}/libexec/ikigai
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        BRAVE_API_KEY: ${{ secrets.BRAVE_API_KEY }}
        GOOGLE_SEARCH_API_KEY: ${{ secrets.GOOGLE_SEARCH_API_KEY }}
        GOOGLE_SEARCH_ENGINE_ID: ${{ secrets.GOOGLE_SEARCH_ENGINE_ID }}
        NTFY_API_KEY: ${{ secrets.NTFY_API_KEY }}
        NTFY_TOPIC: ${{ secrets.NTFY_TOPIC }}

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: ikigai
          POSTGRES_PASSWORD: ikigai
          POSTGRES_DB: ikigai
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - uses: actions/checkout@v4

    - name: Install build dependencies
      run: |
        apt-get update
        apt-get upgrade -y
        apt-get install -y \
          build-essential \
          uncrustify \
          complexity \
          check \
          libtalloc-dev \
          libulfius-dev \
          libcurl4-gnutls-dev \
          uuid-dev \
          libb64-dev \
          libutf8proc-dev \
          libpq-dev \
          libxkbcommon-dev \
          postgresql-client \
          lcov \
          valgrind \
          git \
          sudo \
          libxml2-dev \
          bc \
          debhelper \
          dpkg-dev \
          fakeroot

    - name: Show tool versions
      run: |
        echo "Debian version:" && cat /etc/debian_version
        echo "gcc:" && gcc --version | head -1
        echo "lcov package:" && dpkg -l lcov | grep lcov
        echo "lcov binary:" && lcov --version
        echo "Working directory:" && pwd
        echo "IKIGAI_DATA_DIR: $IKIGAI_DATA_DIR"
        echo "IKIGAI_LIBEXEC_DIR: $IKIGAI_LIBEXEC_DIR"

    - name: Verify PostgreSQL connectivity
      run: |
        psql "postgresql://ikigai:ikigai@postgres/ikigai" -c "SELECT 1"

    - name: check-compile
      run: make check-compile

    - name: check-link
      run: make check-link

    - name: check-filesize
      run: make check-filesize

    - name: Debug failing tests
      run: |
        rm -rf /tmp/.ikigai
        echo "=== Working directory and paths ==="
        pwd
        ls -la libexec/ikigai/ || echo "libexec/ikigai not found"
        echo "=== Running file_read_test with output ==="
        ./build/tests/unit/tools/file_read_test 2>&1 || echo "Exit code: $?"
        echo "=== Running zzz_migration_errors_test with output ==="
        ./build/tests/unit/db/zzz_migration_errors_test 2>&1 || echo "Exit code: $?"
        echo "=== Running anthropic_streaming_basic_test with output ==="
        ./build/tests/unit/providers/anthropic/anthropic_streaming_basic_test 2>&1 || echo "Exit code: $?"

    - name: check-unit
      run: |
        rm -rf /tmp/.ikigai
        make check-unit

    - name: check-integration
      run: |
        rm -rf /tmp/.ikigai
        make check-integration

    - name: check-complexity
      run: make check-complexity

    - name: check-sanitize
      run: |
        rm -rf /tmp/.ikigai
        make clean
        make check-sanitize

    - name: check-tsan
      run: |
        rm -rf /tmp/.ikigai
        make clean
        make check-tsan

    - name: check-valgrind
      run: |
        rm -rf /tmp/.ikigai
        make clean
        make check-valgrind

    - name: check-helgrind
      run: |
        rm -rf /tmp/.ikigai
        make clean
        make check-helgrind

    - name: check-coverage
      run: |
        rm -rf /tmp/.ikigai
        make clean
        make check-coverage
