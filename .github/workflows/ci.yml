name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    container:
      image: debian:13.2@sha256:c71b05eac0b20adb4cdcc9f7b052227efd7da381ad10bb92f972e8eae7c6cdc9
      env:
        PGHOST: postgres
        IKIGAI_DEV: 1
        IKIGAI_BIN_DIR: /workspace/bin
        IKIGAI_CONFIG_DIR: /workspace/etc/ikigai
        IKIGAI_DATA_DIR: /workspace/share/ikigai
        IKIGAI_LIBEXEC_DIR: /workspace/libexec/ikigai
        BRAVE_API_KEY: ${{ secrets.BRAVE_API_KEY }}
        GOOGLE_SEARCH_API_KEY: ${{ secrets.GOOGLE_SEARCH_API_KEY }}
        GOOGLE_SEARCH_ENGINE_ID: ${{ secrets.GOOGLE_SEARCH_ENGINE_ID }}
        NTFY_API_KEY: ${{ secrets.NTFY_API_KEY }}
        NTFY_TOPIC: ${{ secrets.NTFY_TOPIC }}

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: ikigai
          POSTGRES_PASSWORD: ikigai
          POSTGRES_DB: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - uses: actions/checkout@v4

    - name: Install build dependencies
      run: |
        apt-get update
        apt-get upgrade -y
        apt-get install -y \
          build-essential \
          uncrustify \
          complexity \
          check \
          libtalloc-dev \
          libulfius-dev \
          libcurl4-gnutls-dev \
          uuid-dev \
          libb64-dev \
          libutf8proc-dev \
          libpq-dev \
          libxkbcommon-dev \
          postgresql-client \
          lcov \
          valgrind \
          git \
          sudo \
          libxml2-dev \
          bc \
          debhelper \
          dpkg-dev \
          fakeroot

    - name: Show tool versions
      run: |
        echo "Debian version:" && cat /etc/debian_version
        echo "gcc:" && gcc --version | head -1
        echo "lcov package:" && dpkg -l lcov | grep lcov
        echo "lcov binary:" && lcov --version

    - name: Check file sizes
      run: make check-filesize

    - name: Check complexity
      run: make check-complexity

    - name: Clean test directories
      run: rm -rf /tmp/.ikigai

    - name: Run tests with coverage
      run: make check-coverage

    - name: Clean before sanitizer build
      run: |
        rm -rf /tmp/.ikigai
        make clean

    - name: Run AddressSanitizer tests
      run: make check-sanitize

    - name: Clean before tsan build
      run: |
        rm -rf /tmp/.ikigai
        make clean

    - name: Run ThreadSanitizer tests
      run: make check-tsan
