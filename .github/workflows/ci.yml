name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: ikigai
          POSTGRES_PASSWORD: ikigai
          POSTGRES_DB: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - uses: actions/checkout@v4

    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          uncrustify \
          complexity \
          check \
          libtalloc-dev \
          libulfius-dev \
          libcurl4-gnutls-dev \
          uuid-dev \
          libb64-dev \
          libutf8proc-dev \
          libpq-dev \
          libxkbcommon-dev \
          postgresql-client \
          lcov \
          valgrind

    - name: Show tool versions
      run: |
        lcov --version
        gcc --version | head -1

    - name: Install vendored dependencies
      run: make install-deps

    - name: Check file sizes
      run: make check-filesize

    - name: Check complexity
      run: make check-complexity

    - name: Clean test directories
      run: rm -rf /tmp/.ikigai

    - name: Run tests with coverage
      run: make check-coverage

    - name: Clean before sanitizer build
      run: |
        rm -rf /tmp/.ikigai
        make clean

    - name: Run AddressSanitizer tests
      run: make check-sanitize

    - name: Clean before tsan build
      run: |
        rm -rf /tmp/.ikigai
        make clean

    - name: Run ThreadSanitizer tests
      run: make check-tsan
