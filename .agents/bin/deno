#!/bin/bash
set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
AGENTS_DIR="$(dirname "$SCRIPT_DIR")"
DENO_DIR="$AGENTS_DIR/deno"
DENO_BIN="$DENO_DIR/bin/deno"

if [ ! -x "$DENO_BIN" ]; then
    echo "Installing deno to $DENO_DIR..." >&2
    mkdir -p "$DENO_DIR/bin"

    # Determine target architecture
    case "$(uname -sm)" in
        "Linux x86_64")  target="x86_64-unknown-linux-gnu" ;;
        "Linux aarch64") target="aarch64-unknown-linux-gnu" ;;
        "Darwin x86_64") target="x86_64-apple-darwin" ;;
        "Darwin arm64")  target="aarch64-apple-darwin" ;;
        *) echo "Unsupported platform: $(uname -sm)" >&2; exit 1 ;;
    esac

    # Download latest release from GitHub
    curl -fsSL "https://github.com/denoland/deno/releases/latest/download/deno-${target}.zip" -o /tmp/deno.zip
    unzip -oq /tmp/deno.zip -d "$DENO_DIR/bin"
    rm /tmp/deno.zip
    chmod +x "$DENO_BIN"

    echo "Deno installed successfully" >&2
fi

exec "$DENO_BIN" "$@"
