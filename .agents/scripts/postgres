#!/bin/bash
set -e

# Add PostgreSQL binaries to PATH
export PATH="/usr/lib/postgresql/17/bin:$PATH"

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
AGENTS_DIR="$(dirname "$SCRIPT_DIR")"
DB_DIR="$AGENTS_DIR/db"
DATA_DIR="$DB_DIR/data"
LOGS_DIR="$AGENTS_DIR/logs"
ARCHIVE_DIR="$LOGS_DIR/archive"
LOG_FILE="$LOGS_DIR/postgres.log"

PORT=15432
DB_USER="ikigai"
DB_NAME="ikigai"
DB_PASS="ikigai"

mkdir -p "$DB_DIR" "$LOGS_DIR" "$ARCHIVE_DIR"

# Archive existing log
if [ -f "$LOG_FILE" ] && [ -s "$LOG_FILE" ]; then
    TIMESTAMP=$(date +%Y%m%d-%H%M%S)
    mv "$LOG_FILE" "$ARCHIVE_DIR/postgres-$TIMESTAMP.log"
fi

# Initialize cluster if needed
if [ ! -d "$DATA_DIR" ]; then
    echo "Initializing PostgreSQL cluster..."
    initdb -D "$DATA_DIR" --auth=trust --no-locale --encoding=UTF8

    # Configure postgresql.conf
    cat >> "$DATA_DIR/postgresql.conf" <<EOF

# Ikigai configuration
port = $PORT
listen_addresses = 'localhost'
unix_socket_directories = '$DB_DIR'
logging_collector = on
log_directory = '$LOGS_DIR'
log_filename = 'postgres.log'
log_destination = 'stderr'
EOF

    # Start temporarily to create user and database
    pg_ctl -D "$DATA_DIR" -l "$LOG_FILE" -o "-p $PORT" start

    # Wait for postgres to be ready
    until pg_isready -h localhost -p $PORT -q; do
        sleep 0.5
    done

    # Create user and database
    createuser -h localhost -p $PORT -s "$DB_USER" 2>/dev/null || true
    psql -h localhost -p $PORT -c "ALTER USER $DB_USER PASSWORD '$DB_PASS';" postgres
    createdb -h localhost -p $PORT -O "$DB_USER" "$DB_NAME" 2>/dev/null || true

    # Stop temporary instance
    pg_ctl -D "$DATA_DIR" stop

    echo "PostgreSQL initialized with user '$DB_USER' and database '$DB_NAME'"
fi

# Run postgres in foreground
exec postgres -D "$DATA_DIR" -p $PORT
