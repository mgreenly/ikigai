# Installation Directory Structure

Complete specification for ikigai installation paths using wrapper script approach.

## Overview

ikigai uses a **wrapper script approach** where all path configuration happens at install time. The Makefile generates a wrapper script that sets environment variables, and the C code simply reads them.

**Supported PREFIX values:**
1. `/usr` - System install (distro packages)
2. `/usr/local` - Local admin install (default)
3. `/opt/ikigai` - Optional software install
4. `$HOME/.local` - User install

**Key insight:** Each PREFIX has different directory conventions. The wrapper script handles all the complexity - the C code is identical for all installs.

## Wrapper Script Approach

### Install Structure

```
$PREFIX/bin/ikigai              # wrapper script (generated by make install)
$PREFIX/libexec/ikigai/ikigai   # actual binary
$PREFIX/libexec/ikigai/bash     # tool executables
$PREFIX/libexec/ikigai/file-read
...
```

### How It Works

1. **Install time:** Makefile generates wrapper script with correct paths for the PREFIX
2. **Runtime:** Wrapper sets 4 environment variables and execs actual binary
3. **C code:** Reads environment variables, no detection logic needed

## Directory Layouts by PREFIX

### PREFIX=/usr/local (Default)

```
/usr/local/
├── bin/ikigai                      # wrapper script
├── etc/ikigai/config.json          # config
├── share/ikigai/*                  # data files
└── libexec/ikigai/
    ├── ikigai                      # actual binary
    ├── bash                        # tools
    ├── file-read
    ├── file-write
    ├── file-edit
    ├── glob
    └── grep
```

**Wrapper script:**
```bash
#!/bin/sh
IKIGAI_BIN_DIR=/usr/local/bin
IKIGAI_CONFIG_DIR=/usr/local/etc/ikigai
IKIGAI_DATA_DIR=/usr/local/share/ikigai
IKIGAI_LIBEXEC_DIR=/usr/local/libexec/ikigai
export IKIGAI_BIN_DIR IKIGAI_CONFIG_DIR IKIGAI_DATA_DIR IKIGAI_LIBEXEC_DIR
exec /usr/local/libexec/ikigai/ikigai "$@"
```

### PREFIX=/usr (Distro Packages)

```
/usr/
├── bin/ikigai                      # wrapper script
├── share/ikigai/*                  # data files
└── libexec/ikigai/
    ├── ikigai                      # actual binary
    └── (tools)

/etc/ikigai/config.json             # config (special case: /etc not /usr/etc)
```

**Wrapper script:**
```bash
#!/bin/sh
IKIGAI_BIN_DIR=/usr/bin
IKIGAI_CONFIG_DIR=/etc/ikigai
IKIGAI_DATA_DIR=/usr/share/ikigai
IKIGAI_LIBEXEC_DIR=/usr/libexec/ikigai
export IKIGAI_BIN_DIR IKIGAI_CONFIG_DIR IKIGAI_DATA_DIR IKIGAI_LIBEXEC_DIR
exec /usr/libexec/ikigai/ikigai "$@"
```

**Note:** Config goes to `/etc/ikigai/` per FHS convention.

### PREFIX=/opt/ikigai (Optional Software)

```
/opt/ikigai/
├── bin/ikigai                      # wrapper script
├── etc/config.json                 # config (no double "ikigai" dir)
├── share/*                         # data files (no double "ikigai" dir)
└── libexec/
    ├── ikigai                      # actual binary
    └── (tools)
```

**Wrapper script:**
```bash
#!/bin/sh
IKIGAI_BIN_DIR=/opt/ikigai/bin
IKIGAI_CONFIG_DIR=/opt/ikigai/etc
IKIGAI_DATA_DIR=/opt/ikigai/share
IKIGAI_LIBEXEC_DIR=/opt/ikigai/libexec
export IKIGAI_BIN_DIR IKIGAI_CONFIG_DIR IKIGAI_DATA_DIR IKIGAI_LIBEXEC_DIR
exec /opt/ikigai/libexec/ikigai/ikigai "$@"
```

**Note:** No double directory name - PREFIX already contains "ikigai".

### PREFIX=$HOME/.local (User Install)

```
$HOME/.local/
├── bin/ikigai                      # wrapper script
├── share/ikigai/*                  # data files
└── libexec/ikigai/
    ├── ikigai                      # actual binary
    └── (tools)

$HOME/.config/ikigai/config.json    # config (XDG location, not .local/etc)
```

**Wrapper script:**
```bash
#!/bin/sh
IKIGAI_BIN_DIR=$HOME/.local/bin
IKIGAI_CONFIG_DIR=$HOME/.config/ikigai
IKIGAI_DATA_DIR=$HOME/.local/share/ikigai
IKIGAI_LIBEXEC_DIR=$HOME/.local/libexec/ikigai
export IKIGAI_BIN_DIR IKIGAI_CONFIG_DIR IKIGAI_DATA_DIR IKIGAI_LIBEXEC_DIR
exec $HOME/.local/libexec/ikigai/ikigai "$@"
```

**Note:** Config uses XDG location `~/.config/ikigai/` (respects `$XDG_CONFIG_HOME` at install time).

## Development Mode

For development (running from source tree), use `.envrc`:

```bash
# .envrc in project root
export IKIGAI_BIN_DIR=$PWD/bin
export IKIGAI_CONFIG_DIR=$PWD/etc/ikigai
export IKIGAI_DATA_DIR=$PWD/share/ikigai
export IKIGAI_LIBEXEC_DIR=$PWD/libexec/ikigai
```

Then:
```bash
direnv allow
./libexec/ikigai/ikigai  # Environment automatically set
```

**Alternative:** Create `bin/ikigai` wrapper script in repo.

## Environment Variables

The wrapper script sets these 4 variables:

| Variable | Purpose | Example Value |
|----------|---------|---------------|
| `IKIGAI_BIN_DIR` | Binary directory | `/usr/local/bin` |
| `IKIGAI_CONFIG_DIR` | Configuration files | `/usr/local/etc/ikigai` |
| `IKIGAI_DATA_DIR` | Documentation, examples | `/usr/local/share/ikigai` |
| `IKIGAI_LIBEXEC_DIR` | Helper executables (tools) | `/usr/local/libexec/ikigai` |

## Tool Discovery Paths

ikigai always scans **three directories** for tools:

### 1. System Tools Directory

**Purpose:** Tools shipped with ikigai (6 built-in tools)

**Path:** From `IKIGAI_LIBEXEC_DIR` environment variable

**Examples:**
- PREFIX=/usr/local → `/usr/local/libexec/ikigai/`
- PREFIX=/usr → `/usr/libexec/ikigai/`
- PREFIX=/opt/ikigai → `/opt/ikigai/libexec/`
- PREFIX=$HOME/.local → `$HOME/.local/libexec/ikigai/`

### 2. User Tools Directory

**Purpose:** Personal custom tools available across all projects

**Path:** Always `~/.ikigai/tools/` (fixed, not from env var)

**Rationale:** Clear, discoverable location for user-added tools.

### 3. Project Tools Directory

**Purpose:** Project-specific tools local to working directory

**Path:** Always `.ikigai/tools/` (relative to CWD, not from env var)

**Rationale:** Project-local tools override user and system tools.

### Override Precedence

When the same tool name exists in multiple directories:

**Project > User > System** (most specific wins)

## C Implementation

### paths.c

```c
// src/paths.c
struct ik_paths_t {
    char *bin_dir;              // From IKIGAI_BIN_DIR
    char *config_dir;           // From IKIGAI_CONFIG_DIR
    char *data_dir;             // From IKIGAI_DATA_DIR
    char *tools_system_dir;     // From IKIGAI_LIBEXEC_DIR
    char *tools_user_dir;       // Always ~/.ikigai/tools/
    char *tools_project_dir;    // Always .ikigai/tools/
};

res_t ik_paths_init(TALLOC_CTX *ctx, ik_paths_t **out) {
    ik_paths_t *paths = talloc_zero(ctx, ik_paths_t);

    // Read from environment (set by wrapper script)
    const char *bin = getenv("IKIGAI_BIN_DIR");
    const char *config = getenv("IKIGAI_CONFIG_DIR");
    const char *data = getenv("IKIGAI_DATA_DIR");
    const char *libexec = getenv("IKIGAI_LIBEXEC_DIR");

    if (!bin || !config || !data || !libexec) {
        return ERR(ERR_INVALID_STATE, "Missing IKIGAI_*_DIR environment variables");
    }

    // Copy to paths struct
    paths->bin_dir = talloc_strdup(paths, bin);
    paths->config_dir = talloc_strdup(paths, config);
    paths->data_dir = talloc_strdup(paths, data);
    paths->tools_system_dir = talloc_strdup(paths, libexec);

    // These are always the same regardless of install
    paths->tools_user_dir = expand_tilde(paths, "~/.ikigai/tools");
    paths->tools_project_dir = talloc_strdup(paths, ".ikigai/tools");

    *out = paths;
    return OK();
}
```

**Key point:** No install type detection, no PREFIX extraction, no complex logic. Just read environment variables.

## Makefile Install/Uninstall

### Install

```bash
# Default install to /usr/local
make install

# Install to custom PREFIX
PREFIX=/opt/ikigai make install

# User install
PREFIX=$HOME/.local make install

# Force overwrite existing config files
FORCE=1 PREFIX=$HOME/.local make install
```

**What gets installed:**
- Binary: `$(PREFIX)/libexec/ikigai/ikigai`
- Wrapper script: `$(PREFIX)/bin/ikigai`
- Config files: `config.json`, `credentials.example.json` (in configdir)
- Migrations: `*.sql` files (in datadir/migrations)

**Config file behavior:**
- **Default:** Only installs if file doesn't exist (safe upgrades)
- **FORCE=1:** Overwrites existing config files

### Uninstall

```bash
# Default uninstall from /usr/local (preserves config files)
make uninstall

# Uninstall from custom PREFIX (preserves config files)
PREFIX=/opt/ikigai make uninstall

# Uninstall and remove config files
PURGE=1 PREFIX=$HOME/.local make uninstall
```

**What gets removed:**
- Binary: `$(PREFIX)/libexec/ikigai/ikigai`
- Wrapper script: `$(PREFIX)/bin/ikigai`
- Empty directories: libexec/ikigai, libexec, configdir, datadir/ikigai

**With PURGE=1:**
- Also removes: `config.json`, `credentials.json`, `credentials.example.json`

**Important:** Uninstall must use the same PREFIX as install.

### XDG Support for User Installs

When `PREFIX` is under `/home/*` (user install), the Makefile uses XDG Base Directory spec:

**At install time:**
- Reads `$XDG_CONFIG_HOME` (default: `$HOME/.config`)
- Reads `$XDG_DATA_HOME` (default: `$HOME/.local/share`)
- Writes resolved paths to wrapper script

**Example with XDG vars set:**
```bash
export XDG_CONFIG_HOME=/custom/config
export XDG_DATA_HOME=/custom/data
PREFIX=$HOME/.local make install
```

Wrapper script will use:
```bash
IKIGAI_CONFIG_DIR=/custom/config/ikigai
IKIGAI_DATA_DIR=/custom/data/ikigai
```

**Example without XDG vars (default):**
```bash
PREFIX=$HOME/.local make install
```

Wrapper script will use:
```bash
IKIGAI_CONFIG_DIR=$HOME/.config/ikigai
IKIGAI_DATA_DIR=$HOME/.local/share/ikigai
```

## Summary Table

| PREFIX | Binary Wrapper | Actual Binary | Config | Data | Libexec |
|--------|----------------|---------------|--------|------|---------|
| `/usr` | `/usr/bin/ikigai` | `/usr/libexec/ikigai/ikigai` | `/etc/ikigai/` | `/usr/share/ikigai/` | `/usr/libexec/ikigai/` |
| `/usr/local` | `/usr/local/bin/ikigai` | `/usr/local/libexec/ikigai/ikigai` | `/usr/local/etc/ikigai/` | `/usr/local/share/ikigai/` | `/usr/local/libexec/ikigai/` |
| `/opt/ikigai` | `/opt/ikigai/bin/ikigai` | `/opt/ikigai/libexec/ikigai` | `/opt/ikigai/etc/` | `/opt/ikigai/share/` | `/opt/ikigai/libexec/` |
| `$HOME/.local` | `$HOME/.local/bin/ikigai` | `$HOME/.local/libexec/ikigai/ikigai` | `$HOME/.config/ikigai/` | `$HOME/.local/share/ikigai/` | `$HOME/.local/libexec/ikigai/` |

**User tools:** Always `~/.ikigai/tools/` (all PREFIX values)
**Project tools:** Always `.ikigai/tools/` (all PREFIX values)

## Installed Files

### All Installs

**Binaries:**
- Wrapper script: `$(bindir)/ikigai` (generated at install time)
- Actual binary: `$(libexecdir)/ikigai/ikigai`

**Config files:** (in `$(configdir)`)
- `config.json` - Main configuration
- `credentials.example.json` - Template for credentials

**Data files:** (in `$(datadir)/ikigai`)
- Database migrations: `migrations/*.sql`

**Note:** `credentials.json` is NOT installed (user creates from example)

### Install Type Detection

Makefile detects install type from PREFIX:

```make
IS_OPT_INSTALL := $(if $(filter /opt%,$(PREFIX)),yes,no)
IS_USER_INSTALL := $(if $(findstring /home/,$(PREFIX)),yes,no)
```

**Detection rules:**
1. `PREFIX=/usr` → System install, special `/etc` handling
2. `PREFIX=/opt/*` → Opt install, no double directory names
3. `PREFIX=/home/*` → User install, use XDG paths
4. Others → Standard PREFIX-based paths

### Migration Files

**Source:** `share/ikigai/migrations/*.sql`

**Installed to:** `$(datadir)/ikigai/migrations/`

**Examples:**
- PREFIX=/usr/local → `/usr/local/share/ikigai/migrations/`
- PREFIX=$HOME/.local → `$HOME/.local/share/ikigai/migrations/`

**Usage:** Database initialization reads from `$(datadir)/ikigai/migrations/`

## Design Rationale

### Why Wrapper Script?

**Problem:** Different PREFIX values require different directory structures:
- `/usr` → `/etc/ikigai/` (not `/usr/etc/ikigai/`)
- `/opt/ikigai` → `/opt/ikigai/etc/` (no double directory name)
- `$HOME/.local` → `~/.config/ikigai/` (XDG standard)

**Solution:** Generate wrapper at install time with correct paths for each PREFIX.

**Benefits:**
1. **Simple C code** - No install type detection, just read env vars
2. **Flexible** - Supports any PREFIX with correct wrapper
3. **Relocatable** - Move entire PREFIX tree, wrapper still works
4. **Development-friendly** - Works with .envrc (direnv)
5. **Test-friendly** - Tests override env vars easily

### Why Four Environment Variables?

Each directory serves a distinct purpose and may have different paths:
- `IKIGAI_BIN_DIR` - Where wrapper script lives
- `IKIGAI_CONFIG_DIR` - Config files (varies by PREFIX)
- `IKIGAI_DATA_DIR` - Documentation, examples
- `IKIGAI_LIBEXEC_DIR` - System tools (executables not in PATH)

### Why `~/.ikigai/tools/` Not XDG?

- Tools are executables, not configuration or data
- No XDG standard for user-installed executables outside PATH
- Clearer separation: config in `~/.config/`, tools in `~/.ikigai/`
- More discoverable ("where do I put custom tools?")

### Why No Config Cascading?

Each install has exactly one config location. No search order, no cascading.

**Rationale:**
- Simpler to understand ("where is my config?")
- Clearer ownership (one install, one config)
- Avoids surprising behavior (which config is active?)

## Testing Strategy

Tests set environment variables directly:

```c
// Set environment before test
setenv("IKIGAI_BIN_DIR", "/test/bin", 1);
setenv("IKIGAI_CONFIG_DIR", "/test/config", 1);
setenv("IKIGAI_DATA_DIR", "/test/data", 1);
setenv("IKIGAI_LIBEXEC_DIR", "/test/libexec", 1);

ik_paths_t *paths = NULL;
res_t result = ik_paths_init(test_ctx, &paths);

assert(result.ok);
assert_string_equal(ik_paths_get_config_dir(paths), "/test/config");

// Clean up
unsetenv("IKIGAI_BIN_DIR");
unsetenv("IKIGAI_CONFIG_DIR");
unsetenv("IKIGAI_DATA_DIR");
unsetenv("IKIGAI_LIBEXEC_DIR");
```

**Test helper for most tests:**
```c
ik_paths_t *ik_paths_create_test(TALLOC_CTX *ctx) {
    ik_paths_t *paths = talloc_zero(ctx, ik_paths_t);
    paths->bin_dir = talloc_strdup(paths, "tests/bin");
    paths->config_dir = talloc_strdup(paths, "tests/config");
    paths->data_dir = talloc_strdup(paths, "tests/data");
    paths->tools_system_dir = talloc_strdup(paths, "tests/tools/system");
    paths->tools_user_dir = talloc_strdup(paths, "tests/tools/user");
    paths->tools_project_dir = talloc_strdup(paths, "tests/tools/project");
    return paths;
}
```

## Future Considerations

### Additional PREFIX Values

The wrapper script approach easily extends to new PREFIX values:
- `/Applications/ikigai.app/` (macOS app bundle)
- Custom locations via `PREFIX=/any/path make install-prefix`

Just add conditional in Makefile `generate-wrapper` target.

### Windows Support

Would need different approach (no shell wrapper):
- Registry keys for install paths
- Or: config file with install locations
- Or: hardcode paths at compile time

### macOS Support

Works with wrapper script approach:
- Homebrew: `PREFIX=/usr/local` (already supported)
- MacPorts: `PREFIX=/opt/local` (add to Makefile)
- App bundle: `PREFIX=/Applications/ikigai.app/Contents/Resources`

Could use `~/.config/ikigai/` (XDG) or `~/Library/Application Support/ikigai/` (macOS convention).
