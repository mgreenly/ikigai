#!/usr/bin/env ruby
# frozen_string_literal: true

# Terminal watcher for .ralphs/ directory
# Shows current ralph clone directories with flicker-free updates

RALPHS_DIR = '.ralphs'
REFRESH_INTERVAL = 1.5 # seconds

# ANSI escape codes
HIDE_CURSOR = "\e[?25l"
SHOW_CURSOR = "\e[?25h"
MOVE_HOME = "\e[H"
CLEAR_SCREEN = "\e[2J"
CLEAR_TO_END = "\e[J"
CLEAR_LINE = "\e[K"

# Trap Ctrl+C for clean exit
trap('INT') do
  print SHOW_CURSOR
  puts "\nExiting..."
  exit 0
end

# Initialize: clear screen and hide cursor
print CLEAR_SCREEN
print HIDE_CURSOR

begin
  loop do
    # Move cursor to top-left
    print MOVE_HOME

    # Display header with timestamp
    timestamp = Time.now.strftime('%Y-%m-%d %H:%M:%S')
    print "=== Active Ralphs (#{timestamp}) ===#{CLEAR_LINE}\n\n"

    # Check if .ralphs directory exists
    if Dir.exist?(RALPHS_DIR)
      # Traverse .ralphs/<org>/<repo>/<number>/ structure
      entries = []
      Dir.glob(File.join(RALPHS_DIR, '*', '*', '*')).each do |path|
        next unless File.directory?(path)
        parts = path.split(File::SEPARATOR)
        next unless parts.length >= 3
        org = parts[-3]
        repo = parts[-2]
        number = parts[-1]
        entries << { org: org, repo: repo, number: number.to_i }
      end

      # Sort by number
      entries.sort_by! { |e| e[:number] }

      if entries.empty?
        print "No active ralphs#{CLEAR_LINE}\n"
      else
        entries.each do |entry|
          print "  #{entry[:org]}/#{entry[:repo]}/#{entry[:number]}#{CLEAR_LINE}\n"
        end
      end
    else
      print "No active ralphs#{CLEAR_LINE}\n"
    end

    # Clear any remaining lines from previous display
    print CLEAR_TO_END

    # Wait before next refresh
    sleep REFRESH_INTERVAL
  end
ensure
  # Restore cursor on exit
  print SHOW_CURSOR
end
