#!/usr/bin/env ruby
# frozen_string_literal: true

#
# harness/story-try-close - Check if a story should be closed after a goal completes
#
# Usage: story-try-close <goal_number>
#
# Output: JSON {"ok": true, "closed": true/false, "story": N}
# Exit code: 0 on success, 1 on failure
#

require 'json'

def has_label?(labels, target)
  labels.any? do |label|
    name = label.is_a?(Hash) ? label['name'] : label.to_s
    name == target
  end
end

def parse_story_ref(body)
  return nil if body.nil?

  match = body.match(/Story:\s*#(\d+)/)
  match ? match[1].to_i : nil
end

def get_goal(number)
  cmd = [
    'gh', 'issue', 'view', number.to_s,
    '--json', 'number,title,labels,body,state'
  ]

  stdout = IO.popen(cmd, err: '/dev/null', &:read)
  return nil if $?.exitstatus != 0

  JSON.parse(stdout) rescue nil
end

def get_story(number)
  cmd = [
    'gh', 'issue', 'view', number.to_s,
    '--json', 'number,title,labels,body,state'
  ]

  stdout = IO.popen(cmd, err: '/dev/null', &:read)
  return nil if $?.exitstatus != 0

  JSON.parse(stdout) rescue nil
end

def find_linked_goals(story_number)
  # Search for goals that reference this story
  cmd = [
    'gh', 'issue', 'list',
    '--label', 'pipeline,goal',
    '--json', 'number,title,labels,body',
    '--limit', '100',
    '--state', 'all'
  ]

  stdout = IO.popen(cmd, err: '/dev/null', &:read)
  return [] if $?.exitstatus != 0

  issues = JSON.parse(stdout) rescue []

  issues.select do |issue|
    body = issue['body'] || ''
    body.match?(/Story:\s*##{story_number}\b/)
  end
end

def all_goals_done?(goals)
  return false if goals.empty?

  goals.all? do |goal|
    labels = goal['labels'] || []
    has_label?(labels, 'goal:done')
  end
end

def close_story(number)
  cmd = ['gh', 'issue', 'close', number.to_s]
  IO.popen(cmd, err: '/dev/null', &:read)
  $?.exitstatus == 0
end

def main
  if ARGV.include?('--help') || ARGV.include?('-h')
    puts <<~HELP
      Usage: story-try-close <goal_number>

      Check if a story should be closed after a goal completes.

      Arguments:
        goal_number    GitHub Issue number for a goal (required)

      Behavior:
        1. Fetch the goal issue body
        2. Parse Story: #N from the body to find the parent story number
        3. List all goals linked to that story
        4. If every linked goal has the goal:done label, close the story issue
        5. If not all done, do nothing

      Output:
        JSON {"ok": true, "closed": true/false, "story": N}
        - closed: true if story was closed, false otherwise
        - story: N is the story number (or null if no story reference)

      Edge Cases:
        - Goal has no Story: #N reference → return ok with closed: false
        - Story has no goals → don't close (shouldn't happen but be safe)
        - Story is already closed → return ok with closed: false

      Examples:
        story-try-close 42
    HELP
    exit 0
  end

  goal_number = ARGV[0]&.to_i

  unless goal_number && goal_number > 0
    puts JSON.generate(ok: false, items: ['goal number is required'])
    exit 1
  end

  # Fetch the goal
  goal = get_goal(goal_number)
  unless goal
    puts JSON.generate(ok: false, items: ["goal ##{goal_number} not found"])
    exit 1
  end

  # Verify it's a goal
  labels = goal['labels'] || []
  unless has_label?(labels, 'goal')
    puts JSON.generate(ok: false, items: ["##{goal_number} is not a goal"])
    exit 1
  end

  # Parse story reference
  story_number = parse_story_ref(goal['body'])
  unless story_number
    puts JSON.generate(ok: true, closed: false, story: nil)
    exit 0
  end

  # Fetch the story
  story = get_story(story_number)
  unless story
    puts JSON.generate(ok: false, items: ["story ##{story_number} not found"])
    exit 1
  end

  # Check if story is already closed
  if story['state'] == 'CLOSED'
    puts JSON.generate(ok: true, closed: false, story: story_number)
    exit 0
  end

  # Find all goals linked to this story
  goals = find_linked_goals(story_number)

  # Don't close if no goals (shouldn't happen but be safe)
  if goals.empty?
    puts JSON.generate(ok: true, closed: false, story: story_number)
    exit 0
  end

  # Check if all goals are done
  if all_goals_done?(goals)
    # Close the story
    if close_story(story_number)
      puts JSON.generate(ok: true, closed: true, story: story_number)
      exit 0
    else
      puts JSON.generate(ok: false, items: ["failed to close story ##{story_number}"])
      exit 1
    end
  else
    # Not all goals done, do nothing
    puts JSON.generate(ok: true, closed: false, story: story_number)
    exit 0
  end
end

if __FILE__ == $PROGRAM_NAME
  begin
    main
  rescue Interrupt
    exit 130
  end
end
