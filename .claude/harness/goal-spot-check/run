#!/usr/bin/env ruby
# frozen_string_literal: true

#
# harness/goal-spot-check - Approve or reject a goal after smoke test
#
# Usage: goal-spot-check <number> approve
#        goal-spot-check <number> reject --feedback "..."
#
# approve: swaps goal:spot-check → goal:done
# reject:  swaps goal:spot-check → goal:queued, adds feedback as comment
#
# Output: JSON {"ok": true, "number": <number>}
# Exit code: 0 on success, 1 on failure
#

require 'json'

def main
  if ARGV.include?('--help') || ARGV.include?('-h')
    puts <<~HELP
      Usage: goal-spot-check <number> approve
             goal-spot-check <number> reject --feedback "..."

      Approve or reject a pipeline goal after human smoke test.

      Arguments:
        number    GitHub Issue number (required)
        action    One of: approve, reject (required)

      Flags:
        --feedback "..."    Reason for rejection (required with reject)

      What it does:
        approve: Removes goal:spot-check, adds goal:done.
        reject:  Removes goal:spot-check, adds goal:queued,
                 posts feedback as a comment for the next ralph run.

      Examples:
        goal-spot-check 42 approve
        goal-spot-check 42 reject --feedback "Widget doesn't render on startup"
    HELP
    exit 0
  end

  number = ARGV[0]&.to_i
  action = ARGV[1]

  unless number && number > 0
    puts JSON.generate(ok: false, items: ['issue number is required'])
    exit 1
  end

  unless %w[approve reject].include?(action)
    puts JSON.generate(ok: false, items: ['action must be approve or reject'])
    exit 1
  end

  if action == 'reject'
    # Parse --feedback
    feedback = nil
    args = ARGV[2..]
    while args.any?
      arg = args.shift
      if arg == '--feedback'
        feedback = args.shift
      end
    end

    unless feedback && !feedback.empty?
      puts JSON.generate(ok: false, items: ['--feedback is required with reject'])
      exit 1
    end
  end

  # Remove goal:spot-check
  system('gh', 'issue', 'edit', number.to_s,
         '--remove-label', 'goal:spot-check',
         out: '/dev/null', err: '/dev/null')

  if action == 'approve'
    ok = system('gh', 'issue', 'edit', number.to_s,
                '--add-label', 'goal:done',
                out: '/dev/null', err: '/dev/null')

    unless ok
      puts JSON.generate(ok: false, items: ["failed to update labels on ##{number}"])
      exit 1
    end
  else
    # Re-queue
    ok = system('gh', 'issue', 'edit', number.to_s,
                '--add-label', 'goal:queued',
                out: '/dev/null', err: '/dev/null')

    unless ok
      puts JSON.generate(ok: false, items: ["failed to update labels on ##{number}"])
      exit 1
    end

    # Post feedback as comment
    system('gh', 'issue', 'comment', number.to_s,
           '--body', "Spot-check rejected:\n\n#{feedback}",
           out: '/dev/null', err: '/dev/null')
  end

  puts JSON.generate(ok: true, number: number)
  exit 0
end

if __FILE__ == $PROGRAM_NAME
  begin
    main
  rescue Interrupt
    exit 130
  end
end
