#!/usr/bin/env ruby
# frozen_string_literal: true

#
# harness/story-list - List pipeline stories from GitHub Issues
#
# Usage: story-list [--state open|closed|all]
#
# Output: JSON {"ok": true, "items": [...]}
# Exit code: 0 always
#

require 'json'

VALID_STATES = %w[open closed all].freeze

def main
  if ARGV.include?('--help') || ARGV.include?('-h')
    puts <<~HELP
      Usage: story-list [--state open|closed|all]

      List pipeline stories from GitHub Issues.

      Flags:
        --state    Filter by state: open, closed, all (default: open)

      Output:
        JSON {"ok": true, "items": [...]}
        Each item: {number, title, state}

      Examples:
        story-list                # open stories
        story-list --state all    # all stories
    HELP
    exit 0
  end

  # Parse flags
  state = 'open'
  args = ARGV.dup
  while args.any?
    arg = args.shift
    case arg
    when '--state'
      state = args.shift
    end
  end

  unless VALID_STATES.include?(state)
    puts JSON.generate(ok: false, items: ["invalid state: #{state} (valid: #{VALID_STATES.join(', ')})"])
    exit 0
  end

  # Query GitHub Issues
  cmd = [
    'gh', 'issue', 'list',
    '--label', 'pipeline,story',
    '--json', 'number,title,state',
    '--limit', '100',
    '--state', state
  ]

  stdout = IO.popen(cmd, err: '/dev/null', &:read)

  if $?.exitstatus != 0
    puts JSON.generate(ok: false, items: ['gh issue list failed'])
    exit 0
  end

  issues = JSON.parse(stdout) rescue []

  items = issues.map do |issue|
    {
      number: issue['number'],
      title: issue['title'],
      state: issue['state']
    }
  end

  puts JSON.generate(ok: true, items: items)
  exit 0
end

if __FILE__ == $PROGRAM_NAME
  begin
    main
  rescue Interrupt
    exit 130
  end
end
