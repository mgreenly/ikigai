#!/usr/bin/env ruby
# frozen_string_literal: true

#
# harness/story-create - Create a pipeline story as a GitHub Issue
#
# Reads story body from stdin. Title via flag.
#
# Usage: story-create --title "..." < body.md
#
# Output: JSON {"ok": true, "number": <issue-number>}
# Exit code: 0 on success, 1 on failure
#

require 'json'

def main
  if ARGV.include?('--help') || ARGV.include?('-h')
    puts <<~HELP
      Usage: story-create --title "..." < body.md

      Create a pipeline story as a GitHub Issue. Body is read from stdin.

      Flags:
        --title "..."    Story title (required)

      Output:
        JSON {"ok": true, "number": <issue-number>}

      Examples:
        echo "As a user..." | story-create --title "Widget rendering"

        story-create --title "Pipeline orchestration" <<'EOF'
        ## User Journey
        The developer queues a goal and the orchestrator picks it up...
        EOF
    HELP
    exit 0
  end

  # Parse flags
  title = nil
  args = ARGV.dup
  while args.any?
    arg = args.shift
    case arg
    when '--title'
      title = args.shift
    end
  end

  unless title
    puts JSON.generate(ok: false, items: ['--title is required'])
    exit 1
  end

  # Read body from stdin
  if $stdin.tty?
    puts JSON.generate(ok: false, items: ['body must be provided on stdin'])
    exit 1
  end

  body = $stdin.read.strip

  if body.empty?
    puts JSON.generate(ok: false, items: ['body is empty'])
    exit 1
  end

  # Create GitHub Issue (gh issue create outputs a URL like .../issues/42)
  cmd = [
    'gh', 'issue', 'create',
    '--title', title,
    '--body', body,
    '--label', 'pipeline,story'
  ]

  stdout = IO.popen(cmd, err: '/dev/null', &:read)

  if $?.exitstatus != 0
    puts JSON.generate(ok: false, items: ['gh issue create failed'])
    exit 1
  end

  number = stdout.strip.split('/').last.to_i

  unless number > 0
    puts JSON.generate(ok: false, items: ['could not parse issue number from gh output'])
    exit 1
  end

  puts JSON.generate(ok: true, number: number)
  exit 0
end

if __FILE__ == $PROGRAM_NAME
  begin
    main
  rescue Interrupt
    exit 130
  end
end
