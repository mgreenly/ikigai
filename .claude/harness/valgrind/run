#!/usr/bin/env ruby
# frozen_string_literal: true

require 'json'
require 'optparse'

options = {}
OptionParser.new do |opts|
  opts.banner = 'Usage: check-valgrind [options]'
  opts.on('--file FILE', 'Run check on specific file') do |file|
    options[:file] = file
  end
end.parse!

# Build command
cmd = options[:file] ? "make check-valgrind FILE=#{options[:file]}" : 'make check-valgrind'

# Run and capture output
output = `#{cmd} 2>&1`
exit_code = $?.exitstatus

# Parse ğŸ”´ lines
items = output.each_line.filter_map do |line|
  line = line.strip
  line[2..].strip if line.start_with?('ğŸ”´ ')
end

if exit_code == 0
  puts JSON.generate(ok: true)
else
  puts JSON.generate(ok: false, items: items.empty? ? ['check failed'] : items)
  exit 1
end
