#!/usr/bin/env ruby
# frozen_string_literal: true

require 'json'
require 'optparse'

# Run command and capture output
def run_cmd(cmd)
  output = `#{cmd} 2>&1`
  [$?.exitstatus, output]
end

# Run make check-sanitize (bulk mode)
def run_make_sanitize_bulk
  run_cmd('make check-sanitize')
end

# Run make check-sanitize FILE=<binary> (single file mode)
def run_make_sanitize_file(binary)
  run_cmd("make check-sanitize FILE=#{binary}")
end

# Parse failing test binaries from bulk mode output
def parse_failing_binaries(output)
  binaries = []
  output.each_line do |line|
    line = line.strip
    next unless line.start_with?('ðŸ”´ ')
    path = line[2..].strip
    # Only include paths that look like test binaries
    binaries << path if path.include?('/') && path.start_with?('build-')
  end
  binaries
end

# Parse error lines from FILE= mode output
def parse_error_lines(output)
  lines = []
  output.each_line do |line|
    line = line.strip
    next unless line.start_with?('ðŸ”´ ')
    # Strip the emoji prefix
    content = line[2..].strip
    # Skip separator lines (all = characters)
    next if content.match?(/^=+$/)
    lines << content
  end
  lines
end

def main
  options = {}
  OptionParser.new do |opts|
    opts.banner = 'Usage: run [options]'
    opts.on('--file FILE', 'Run check on specific test binary') do |file|
      options[:file] = file
    end
  end.parse!

  if options[:file]
    # Single file mode - run make check-sanitize FILE=<binary>
    exit_code, output = run_make_sanitize_file(options[:file])
    if exit_code == 0
      puts JSON.generate(ok: true)
      exit 0
    end
    items = parse_error_lines(output)
    if items.empty?
      puts JSON.generate(ok: false, items: ["#{options[:file]}: check failed but no error details"])
    else
      puts JSON.generate(ok: false, items: items)
    end
    exit 1
  end

  # Bulk mode - run make check-sanitize
  exit_code, output = run_make_sanitize_bulk
  if exit_code == 0
    puts JSON.generate(ok: true)
    exit 0
  end

  # Get list of failing binaries
  failing = parse_failing_binaries(output)
  if failing.empty?
    puts JSON.generate(ok: false, items: ['Build or infrastructure failure'])
    exit 1
  end

  puts JSON.generate(ok: false, items: failing)
  exit 1
end

if __FILE__ == $PROGRAM_NAME
  begin
    main
  rescue Interrupt
    exit 130
  end
end
