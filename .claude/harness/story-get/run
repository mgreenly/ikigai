#!/usr/bin/env ruby
# frozen_string_literal: true

#
# harness/story-get - Read a single pipeline story from GitHub Issues
#
# Usage: story-get <number>
#
# Output: JSON {"ok": true, "number": ..., "title": ..., "body": ..., "goals": [...]}
# Exit code: 0 on success, 1 on failure
#

require 'json'

def has_label?(labels, target)
  labels.any? do |label|
    name = label.is_a?(Hash) ? label['name'] : label.to_s
    name == target
  end
end

def find_linked_goals(story_number)
  # Search for goals that reference this story
  cmd = [
    'gh', 'issue', 'list',
    '--label', 'pipeline,goal',
    '--json', 'number,title,labels,body',
    '--limit', '100',
    '--state', 'all'
  ]

  stdout = IO.popen(cmd, err: '/dev/null', &:read)
  return [] if $?.exitstatus != 0

  issues = JSON.parse(stdout) rescue []

  issues.select do |issue|
    body = issue['body'] || ''
    body.match?(/Story:\s*##{story_number}\b/)
  end.map do |issue|
    {
      number: issue['number'],
      title: issue['title']
    }
  end
end

def main
  if ARGV.include?('--help') || ARGV.include?('-h')
    puts <<~HELP
      Usage: story-get <number>

      Read a single pipeline story and its linked goals from GitHub Issues.

      Arguments:
        number    GitHub Issue number (required)

      Output:
        JSON with fields: number, title, state, body, goals
        goals is an array of {number, title} for goals referencing this story.

      Examples:
        story-get 15
        story-get 15 | jq .body
        story-get 15 | jq '.goals[].number'
    HELP
    exit 0
  end

  number = ARGV[0]&.to_i

  unless number && number > 0
    puts JSON.generate(ok: false, items: ['issue number is required'])
    exit 1
  end

  cmd = [
    'gh', 'issue', 'view', number.to_s,
    '--json', 'number,title,labels,body,state'
  ]

  stdout = IO.popen(cmd, err: '/dev/null', &:read)

  if $?.exitstatus != 0
    puts JSON.generate(ok: false, items: ["issue ##{number} not found"])
    exit 1
  end

  issue = JSON.parse(stdout) rescue nil

  unless issue
    puts JSON.generate(ok: false, items: ['could not parse gh output'])
    exit 1
  end

  labels = issue['labels'] || []

  unless has_label?(labels, 'story')
    puts JSON.generate(ok: false, items: ["##{number} is not a story"])
    exit 1
  end

  goals = find_linked_goals(number)

  puts JSON.generate(
    ok: true,
    number: issue['number'],
    title: issue['title'],
    state: issue['state'],
    body: issue['body'],
    goals: goals
  )
  exit 0
end

if __FILE__ == $PROGRAM_NAME
  begin
    main
  rescue Interrupt
    exit 130
  end
end
