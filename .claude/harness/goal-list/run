#!/usr/bin/env ruby
# frozen_string_literal: true

#
# scripts/goal-list - List pipeline goals from GitHub Issues
#
# Usage: goal-list [status]
#
# Arguments:
#   status    Optional. One of: draft, queued, running, spot-check, done, stuck
#             If omitted, lists all goals.
#
# Output: JSON {"ok": true, "items": [...]}
# Exit code: 0 always
#

require 'json'

VALID_STATUSES = %w[draft queued running spot-check done stuck].freeze

STATUS_LABELS = VALID_STATUSES.map { |s| "goal:#{s}" }.freeze

def run_gh(args)
  cmd = ['gh', 'issue', 'list'] + args
  stdout = IO.popen(cmd, err: '/dev/null', &:read)
  [$?.exitstatus, stdout]
end

def parse_story_ref(body)
  return nil if body.nil?

  match = body.match(/Story:\s*#(\d+)/)
  match ? match[1].to_i : nil
end

def extract_status(labels)
  labels.each do |label|
    name = label.is_a?(Hash) ? label['name'] : label.to_s
    STATUS_LABELS.each do |sl|
      return sl.sub('goal:', '') if name == sl
    end
  end
  nil
end

def has_label?(labels, target)
  labels.any? do |label|
    name = label.is_a?(Hash) ? label['name'] : label.to_s
    name == target
  end
end

def main
  if ARGV.include?('--help') || ARGV.include?('-h')
    puts <<~HELP
      Usage: goal-list [status]

      List pipeline goals from GitHub Issues.

      Arguments:
        status    Optional. One of: #{VALID_STATUSES.join(', ')}
                  If omitted, lists all goals.

      Output:
        JSON {"ok": true, "items": [...]}
        Each item: {number, title, status, spot_check, story}

      Examples:
        goal-list              # all goals
        goal-list queued       # only queued goals
        goal-list spot-check   # goals awaiting smoke test
    HELP
    exit 0
  end

  status = ARGV[0]

  if status && !VALID_STATUSES.include?(status)
    puts JSON.generate(ok: false, items: ["invalid status: #{status} (valid: #{VALID_STATUSES.join(', ')})"])
    exit 0
  end

  # Build label filter
  labels = ['pipeline', 'goal']
  labels << "goal:#{status}" if status

  # Query GitHub Issues
  gh_args = [
    '--label', labels.join(','),
    '--json', 'number,title,labels,body',
    '--limit', '100',
    '--state', status == 'done' ? 'closed' : 'open'
  ]

  exit_code, stdout = run_gh(gh_args)

  if exit_code != 0
    puts JSON.generate(ok: false, items: ['gh issue list failed'])
    exit 0
  end

  issues = JSON.parse(stdout) rescue []

  items = issues.map do |issue|
    {
      number: issue['number'],
      title: issue['title'],
      status: extract_status(issue['labels'] || []),
      spot_check: has_label?(issue['labels'] || [], 'spot-check'),
      story: parse_story_ref(issue['body'])
    }
  end

  puts JSON.generate(ok: true, items: items)
  exit 0
end

if __FILE__ == $PROGRAM_NAME
  begin
    main
  rescue Interrupt
    exit 130
  end
end
